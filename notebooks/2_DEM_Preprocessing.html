

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

    <title>2. Digital Elevation Preprocessing &#8212; British Columbia Ungauged Basin Dataset</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/2_DEM_Preprocessing';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3. Pour Point Extraction" href="3_Pour_Point_Extraction.html" />
    <link rel="prev" title="1. Getting Started" href="1_Getting_Started.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../0_intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/bcub-logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/bcub-logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../0_intro.html">
                    BC Ungauged Basin Database (BCUB)
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1_Getting_Started.html">1. Getting Started</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">2. Digital Elevation Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_Pour_Point_Extraction.html">3. Pour Point Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_Basin_Delineation.html">4. Basin Delineation</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_Attribute_Extraction.html">5. Basin Attribute Extraction</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/dankovacek/bcub" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/dankovacek/bcub/issues/new?title=Issue%20on%20page%20%2Fnotebooks/2_DEM_Preprocessing.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/2_DEM_Preprocessing.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>2. Digital Elevation Preprocessing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clip-the-dem">Clip the DEM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hydraulic-conditioning">Hydraulic Conditioning</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flow-direction-accumulation-and-stream-network">Flow Direction, Accumulation, and Stream Network</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="digital-elevation-preprocessing">
<h1>2. Digital Elevation Preprocessing<a class="headerlink" href="#digital-elevation-preprocessing" title="Permalink to this heading">#</a></h1>
<p>In this notebook, we’ll merge the raster tiles and clip them to the Vancouver Island polygon.  We’ll then process the DEM using Whitebox library to generate a stream network.  We need the stream network to generate pour points which are ultimately used for basin delineation.  If you are familiar with ArcGIS or QGIS, you can do the DEM processing using those tools if you prefer.  Ultimately we need a flow direction (d8) raster and a stream network raster for the next steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">rioxarray</span> <span class="k">as</span> <span class="nn">rxr</span>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
<span class="n">dem_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;notebooks/data/DEM/&#39;</span><span class="p">)</span>
<span class="n">dem_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dem_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">)]</span>

<span class="c1"># open a sample dem file and get the resolution and CRS</span>
<span class="n">dem_fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dem_dir</span><span class="p">,</span> <span class="n">dem_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">dem</span><span class="p">,</span> <span class="n">crs</span><span class="p">,</span> <span class="n">affine</span> <span class="o">=</span> <span class="n">retrieve_raster</span><span class="p">(</span><span class="n">dem_fpath</span><span class="p">)</span>

<span class="n">dem_resolution</span> <span class="o">=</span> <span class="n">dem</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">resolution</span><span class="p">()</span>
<span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dem_resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dem_resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DEM is </span><span class="si">{</span><span class="n">dx</span><span class="si">}</span><span class="s1">x</span><span class="si">{</span><span class="n">dy</span><span class="si">}</span><span class="s1">m resolution and is in EPSG </span><span class="si">{</span><span class="n">crs</span><span class="si">}</span><span class="s1"> CRS&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="clip-the-dem">
<h2>Clip the DEM<a class="headerlink" href="#clip-the-dem" title="Permalink to this heading">#</a></h2>
<p>Let’s take the polygon describing Vancouver Island and use it to clip the DEM. We do this so we don’t end up computing the stream network on the ocean surrounding the island, and so that we can identify where rivers drain into the ocean.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>

<span class="n">mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;notebooks/data/region_polygons/Vancouver_Island.geojson&#39;</span><span class="p">)</span>
<span class="n">output_dem_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;notebooks/data/DEM/Vancouver_Island_</span><span class="si">{</span><span class="n">crs</span><span class="si">}</span><span class="s1">.tif&#39;</span><span class="p">)</span>
<span class="n">vrt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;notebooks/data/DEM/USGS_3DEP_mosaic_4269.vrt&#39;</span><span class="p">)</span>

<span class="n">mask</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span>
<span class="n">gtype</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">geom_type</span>
<span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">is_valid</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   ...mask is valid.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_dem_path</span>
</pre></div>
</div>
</div>
</div>
<p>The command below takes the Vancouver Island shoreline polygon and uses it to clip the virtual raster.  The function should take about a minute or so depending upon your system hardware.  Note the resulting file is roughly 1GB, and for the various DEM processing steps you may need up to 1X that in RAM.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;gdalwarp -s_srs epsg:</span><span class="si">{</span><span class="n">crs</span><span class="si">}</span><span class="s1"> -cutline </span><span class="si">{</span><span class="n">mask_path</span><span class="si">}</span><span class="s1"> -cl Vancouver_Island -crop_to_cutline -multi -of gtiff </span><span class="si">{</span><span class="n">vrt_path</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">output_dem_path</span><span class="si">}</span><span class="s1"> -wo NUM_THREADS=ALL_CPUS&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dem_path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Since we will be working with areas and distances, we want the dem in a projected CRS that is representative of the specific location.  Here we use BC Albers (EPSG 3005).  Let’s reproject the DEM.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check # pixels low res</span>
<span class="n">new_crs</span> <span class="o">=</span> <span class="mi">3005</span>
<span class="n">dem_path_reprojected</span> <span class="o">=</span> <span class="n">output_dem_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">crs</span><span class="si">}</span><span class="s1">.tif&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">new_crs</span><span class="si">}</span><span class="s1">.tif&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dem_path_reprojected</span><span class="p">):</span>
    <span class="c1"># reproject to epsg 3005</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">output_dem_path</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;dem&#39;</span><span class="p">)</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">new_crs</span><span class="p">)</span>
    <span class="n">lr</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">dem_path_reprojected</span><span class="p">)</span>
    <span class="n">lr_shape</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dem_resolution</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">resolution</span><span class="p">()</span>
    <span class="n">n_pix</span> <span class="o">=</span> <span class="n">lr_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">lr_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   ...img has </span><span class="si">{</span><span class="n">n_pix</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> pixels&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">dem_path_reprojected</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;   ...</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1"> exists, skipping dem reprojection..&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The command below will try to plot the raster, it should look like the image below.</p>
<figure class="align-default" id="id1">
<a class="reference internal image-reference" href="../_images/vi_dem.png"><img alt="../_images/vi_dem.png" src="../_images/vi_dem.png" style="width: 600px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 2 </span><span class="caption-text">The elevation of Vancouver Island represented in colour.</span><a class="headerlink" href="#id1" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>It may take some time to load</strong> as the raster is about <strong>200 million pixels</strong>.</p>
</div>
<p>Feel free to skip past the next cell and go to the Whitebox import.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.plot</span> <span class="kn">import</span> <span class="n">show</span>
<span class="n">show</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_dem_path</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="hydraulic-conditioning">
<h2>Hydraulic Conditioning<a class="headerlink" href="#hydraulic-conditioning" title="Permalink to this heading">#</a></h2>
<p>The DEM in its unprocessed form will have “pits” or local depressions that will prevent the stream networks from resolving.</p>
<p>We need to run several steps using the Whitebox library:</p>
<ul class="simple">
<li><p><strong>fill depressions</strong>: creates a new DEM raster where pits are filled (<a class="reference external" href="https://www.whiteboxgeo.com/manual/wbt_book/available_tools/hydrological_analysis.html#FillDepressions">Whitebox fill depressions</a>)</p></li>
<li><p><strong>d8 flow direction</strong>: creates a new raster where the values represent the direction of surface flow based on each pixel’s lowest neighbour.(<a class="reference external" href="https://www.whiteboxgeo.com/manual/wbt_book/available_tools/hydrological_analysis.html#D8Pointer">Whitebox d8 pointer</a>)</p></li>
<li><p><strong>flow accumulation</strong>: creates a new raster representing the number of cells upstream of each pixel. (<a class="reference external" href="https://www.whiteboxgeo.com/manual/wbt_book/available_tools/hydrological_analysis.html#D8FlowAccumulation">Whitebox d8 flow accumulation</a>)</p></li>
<li><p><strong>stream network</strong>: creates a new raster where the streams are represented by 1 and hillslopes are represented by 0.  Here we need to set a threshold for the accumulation that yields a stream.  We use a threshold of 1 <span class="math notranslate nohighlight">\(km^2\)</span> but in reality this depends upon several factors and varies in time and space. (<a class="reference external" href="https://www.whiteboxgeo.com/manual/wbt_book/available_tools/stream_network_analysis.html#ExtractStreams">Whitebox extract streams</a>)</p></li>
</ul>
<p>If you have issues, check out the <a class="reference external" href="https://colab.research.google.com/github/giswqs/whitebox-python/blob/master/examples/whitebox.ipynb#scrollTo=d0IJ-5j1NnbK">tutorial from Google Colab on whitebox</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">whitebox</span>

<span class="n">wbt</span> <span class="o">=</span> <span class="n">whitebox</span><span class="o">.</span><span class="n">WhiteboxTools</span><span class="p">()</span>

<span class="c1"># change to True to see more detailed logs</span>
<span class="n">wbt</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<p>Note that to run functions using the whitebox library, we need to provide <strong>absolute urls</strong>, i.e. the full file path (<code class="docutils literal notranslate"><span class="pre">/home/danbot/Documents/code/23/bcub/content/data/DEM/...</span></code>) as opposed to the relative filepath (<code class="docutils literal notranslate"><span class="pre">data/DEM/...</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filled_dem_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dem_dir</span><span class="p">,</span> <span class="n">dem_path_reprojected</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;_filled.tif&#39;</span><span class="p">))</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filled_dem_path</span><span class="p">):</span>
    <span class="n">wbt</span><span class="o">.</span><span class="n">fill_depressions</span><span class="p">(</span>
        <span class="n">dem_path_reprojected</span><span class="p">,</span>
        <span class="n">filled_dem_path</span><span class="p">,</span> 
        <span class="n">fix_flats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">flat_increment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">max_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="flow-direction-accumulation-and-stream-network">
<h2>Flow Direction, Accumulation, and Stream Network<a class="headerlink" href="#flow-direction-accumulation-and-stream-network" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># d8 pointer</span>
<span class="n">d8_pointer_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dem_dir</span><span class="p">,</span> <span class="s1">&#39;Vancouver_Island_d8_pointer.tif&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d8_pointer_path</span><span class="p">):</span>
    <span class="n">wbt</span><span class="o">.</span><span class="n">d8_pointer</span><span class="p">(</span>
        <span class="n">filled_dem_path</span><span class="p">,</span> 
        <span class="n">d8_pointer_path</span><span class="p">,</span> 
        <span class="n">esri_pntr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">callback</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># flow accumulation</span>
<span class="n">acc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dem_dir</span><span class="p">,</span> <span class="s1">&#39;Vancouver_Island_acc.tif&#39;</span><span class="p">)</span>
<span class="n">wbt</span><span class="o">.</span><span class="n">d8_flow_accumulation</span><span class="p">(</span>
    <span class="n">filled_dem_path</span><span class="p">,</span> 
    <span class="n">acc_path</span><span class="p">,</span> 
    <span class="n">out_type</span><span class="o">=</span><span class="s2">&quot;cells&quot;</span><span class="p">,</span> 
    <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
    <span class="n">clip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
    <span class="n">pntr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
    <span class="n">esri_pntr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
    <span class="n">callback</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Before extracting streams, lets calculate the number of pixels representing 1 <span class="math notranslate nohighlight">\(km^2\)</span> at the resolution of the DEM.</p>
<p>Make sure you are looking at the projected dem, otherwise you will be measuring resolution in decimal degrees.  We want the threshold expressed as number of cells/pixels, It should be just over 2000.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">dem_resolution</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;raster resolution is </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">x</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">)</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> m&#39;</span><span class="p">)</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1E6</span> <span class="o">/</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">)))</span> <span class="c1"># 1E6 m^2 = 1 km^2</span>
<span class="n">threshold</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract streams</span>
<span class="n">streams_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dem_dir</span><span class="p">,</span> <span class="s1">&#39;Vancouver_Island_streams.tif&#39;</span><span class="p">)</span>
<span class="n">wbt</span><span class="o">.</span><span class="n">extract_streams</span><span class="p">(</span>
    <span class="n">acc_path</span><span class="p">,</span> 
    <span class="n">streams_path</span><span class="p">,</span> 
    <span class="n">threshold</span><span class="p">,</span> 
    <span class="n">zero_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
    <span class="n">callback</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The final product should now have resolved stream networks, see the example detail below.  Generally if streams do not resolve, there is an issue with the flow direction raster, i.e. check that the flow direction was created from a filled DEM.</p>
<p><img alt="Resulting streams from the processed DEM" src="../_images/streams_result.png" /></p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>River networks derived from digital elevation data are mostly representative, but they are far from perfect.  The figure below is one example of where the stream network as derived from the USGS 3DEP DEM diverges from the watercourse polygon defined in the National Hydrographic Network.  We’ll use the NHN data to filter pour points in the next notebook.</p>
</div>
<figure class="align-default" id="id2">
<a class="reference internal image-reference" href="../_images/reality_of_stream_network_from_dem.png"><img alt="../_images/reality_of_stream_network_from_dem.png" src="../_images/reality_of_stream_network_from_dem.png" style="width: 600px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 3 </span><span class="caption-text">The black squares represent the stream network that will be derived in the next chapter, while the light blue polygon represents a watercourse layer polygon from the National Hydrographic Network dataset.</span><a class="headerlink" href="#id2" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="1_Getting_Started.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">1. Getting Started</p>
      </div>
    </a>
    <a class="right-next"
       href="3_Pour_Point_Extraction.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">3. Pour Point Extraction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clip-the-dem">Clip the DEM</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hydraulic-conditioning">Hydraulic Conditioning</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flow-direction-accumulation-and-stream-network">Flow Direction, Accumulation, and Stream Network</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dan Kovacek
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>